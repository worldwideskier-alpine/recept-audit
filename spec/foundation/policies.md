# foundation / policies（プラットフォーム非依存・生成専用）

> 本書は *生成* に関わる共通規約・フローのみを定義します。**対話（（対話UIに非依存））前提の文言は一切使用しません。**
> 生成結果の通知・配布は CI/CD のアーティファクト、リリース、あるいは任意の成果物ストアを用います。

## 0. スコープと原則（MUST）
- 本書は「生成」のみを対象とする。**環境固有値**や**機能固有の要件**は別紙（env/features）に置く。
- 生成は **再現可能・差分最小** を原則とし、同じ入力に対して同じ成果物が得られる。
- 出力は **ワークツリー**上に作成し、その後 **CI/CD が成果物として収集**・配布する。対話的な「アーティファクト取得」提示は行わない。

## 1. 実行モード
- `full` : 既存生成物を更地化し、**必要ファイルを一式再生成**する。
- `incremental` : 変更影響範囲のみを更新し、未変更部分は保持する。

## 2. AHR（Auto‑Heal & Retry：自動修復）
- Gate 失敗・欠落が検出された場合、**最小差分の修復**を最大 3 ラウンドまで実施し、各ラウンドごとに検査をリラン。
- AHR 対象例：LITERAL 正規化、import/using の注入、HTML LS 必須タグ注入、相対リンクの標準化、ERR‑GUARD の補完 等。
- 仕様逸脱や環境値欠落は AHR 対象外とし、**検査側で不備を明示**する。

## 3. 生成フロー（概略）
1. **前処理**：必要ディレクトリの確保、`spec/foundation/file-globs.yml` の読込、ワークスペース整備。
2. **合成**：生成に必要な仕様（foundation + 当該機能・環境）を結合し、プロンプト/計画を作成。
3. **生成**：コード・設定・スクリプトを出力。`allowed_write` に適合しないパスは書き込み禁止。
4. **検査**：`tools/run_checks.*` を実行し、証跡と `COMPLIANCE.json` を生成。
5. **AHR**：不合格時は最小差分修復→検査を最大 3 ラウンド。
6. **成果物化**：`tools/pack.*` で ZIP/TAR を `dist/` へ出力。**CI/CD がアーティファクトとして公開**する。

## 4. 納品の取り扱い（（対話UIに非依存） 非依存）
- 納品物は **CI/CD のアーティファクト**・**パッケージレジストリ**・**リリース資産**などに発行する。
- ログは CI ジョブログと `evidence/**` に保存し、**人手の “CIアーティファクトのURL提示” は要求しない**。
- 受け入れ判断は `COMPLIANCE.json` と Gate 証跡に基づき **自動**で行う。

## 5. 安全規約
- `spec/**`, `.github/**`, `ai/**` は生成対象外（補助スクリプトの追加は別途合意時に限る）。
- 生成ファイルは **UTF‑8 LF**。外部依存導入は方針に明記された場合のみ可。
- `file-globs.yml` の `forbidden_write` に抵触する変更は破棄し、エラーとする。
