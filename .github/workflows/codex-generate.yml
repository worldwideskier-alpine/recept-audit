name: "Codex Generate (reusable)"

on:
  workflow_call:
    inputs:
      mode:
        description: "full / incremental"
        required: false
        default: "full"
        type: string
      model:
        description: "OpenAI model name"
        required: false
        default: ""
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  REGEN_MODE: "${{ inputs.mode }}"
  SELECTED_MODEL: "${{ inputs.model }}"

jobs:
  generate:
    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"
        with:
          fetch-depth: 0

      - name: "Git identity"
        shell: "bash"
        run: |
          set -eu
          git config --global user.email "ci-bot@example.invalid"
          git config --global user.name  "CI Bot"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: "Require specs"
        shell: "bash"
        run: |
          set -euo pipefail
          for f in spec/generation.txt spec/testing.txt spec/environment.txt spec/functional.txt; do
            [ -f "$f" ] || { echo "::error::Missing spec: $f"; exit 1; }
          done

      - name: "Full regen: wipe tree (keep specs & workflows)"
        if: ${{ env.REGEN_MODE == 'full' }}
        shell: "bash"
        run: |
          set -euo pipefail
          git rm -r --cached . || true
          git add ".github" || true
          git add "spec" || true
          [ -f "AGENTS.md" ]  && git add "AGENTS.md"  || true
          [ -f "README.md" ]  && git add "README.md"  || true
          [ -f ".gitignore" ] && git add ".gitignore" || true
          git clean -fdx -e ".github" -e ".github/workflows" -e "spec" -e "spec/**" -e "AGENTS.md" -e "README.md" -e ".gitignore"
          git commit -m "chore(ai): wipe tree for full regeneration" || echo "no wipe commit"

      - name: "Build prompt"
        id: "prompt"
        shell: "bash"
        run: |
          set -euo pipefail
          PROMPT_FILE="$RUNNER_TEMP/prompt.md"
          : > "$PROMPT_FILE"

          if [ -f "ai/codex-generate.tml" ]; then
            sed -e 's/\r$//' "ai/codex-generate.tml" >> "$PROMPT_FILE"
          else
            cat >> "$PROMPT_FILE" <<'PRE'
          # TASK
          - Clarification はせず即実装。
          - 出力はファイルパッチのみ（説明は出さない）。
          - 生成先: `src/**`（アプリ本体）, `tests/**`（テスト）, 必要に応じて `app.php`, `.htaccess`, `env-lite.php`, `health-lite.php`。
          - 仕様で示した構成を厳守。余分は作らない。

          ## MUST DELIVERABLES
          - app.php
          - src/**
          - tests/**
          - env-lite.php
          - health-lite.php
          - .htaccess
          PRE
          fi

          if [ -f "AGENTS.md" ]; then
            printf "\n\n---\n\n# AGENTS.md\n\n" >> "$PROMPT_FILE"
            sed -e 's/\r$//' "AGENTS.md" >> "$PROMPT_FILE"
          fi

          for f in spec/generation.txt spec/testing.txt spec/environment.txt spec/functional.txt; do
            printf "\n\n---\n\n# %s\n\n" "$f" >> "$PROMPT_FILE"
            sed -e 's/\r$//' "$f" >> "$PROMPT_FILE"
          done

          echo "file=$PROMPT_FILE" >> "$GITHUB_OUTPUT"

      - name: "Check OPENAI_API_KEY"
        env:
          OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
        shell: "bash"
        run: |
          set -eu
          [ -n "${OPENAI_API_KEY:-}" ] || { echo "::error::OPENAI_API_KEY missing"; exit 1; }
          echo "OPENAI_API_KEY present"

      - name: "Run Codex"
        id: "codex"
        uses: "openai/codex-action@main"
        env:
          OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
        with:
          openai-api-key: "${{ secrets.OPENAI_API_KEY }}"
          prompt-file: "${{ steps.prompt.outputs.file }}"
          model: "${{ env.SELECTED_MODEL }}"
          sandbox: "workspace-write"

      - name: "Guard: drop .github/workflows edits"
        shell: "bash"
        run: |
          set -eu
          if git status --porcelain | grep -E '^[AMDR].*\.github/workflows/'; then
            echo "::warning::Discarding .github/workflows changes"
            git checkout -- ".github/workflows" || true
            git restore --staged ".github/workflows" || true
          fi

      - name: "Stage & commit"
        id: "stage"
        shell: "bash"
        run: |
          set -euo pipefail
          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes from Codex."
            exit 0
          fi
          git commit -m "chore(ai): apply Codex generated code"
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: "Create PR"
        if: ${{ steps.stage.outputs.changed == 'true' }}
        uses: "peter-evans/create-pull-request@v7"
        with:
          token: "${{ github.token }}"
          title: "AI: regeneration from specs (${{ inputs.mode }})"
          body: "Automated regeneration by Codex based on specs."
          commit-message: "chore(ai): apply Codex generated code"
          branch: "ai/codex/batch-${{ github.run_id }}"
          base: "main"
          delete-branch: true
