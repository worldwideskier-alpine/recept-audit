name: "Codex Generate (gen+test common, env+func selected + write-back + deliverables)"

on:
  push:
    branches: ["**"]
    paths: ["spec/**", "AGENTS.md"]
  pull_request:
    paths: ["spec/**", "AGENTS.md"]
  workflow_dispatch:
    inputs:
      model:
        description: "（任意）使用するモデル名（未指定＝既定）"
        required: false
      env_spec:
        description: "（任意）環境仕様書のパス（例: spec/environment.prod.txt）"
        required: false
      func_spec:
        description: "（任意）機能仕様書のパス（例: spec/functional.receipts.txt）"
        required: false

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: "codex-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  codex:
    runs-on: "ubuntu-latest"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v4"
        with:
          fetch-depth: 0

      - name: "Set Git identity (CI)"
        shell: "bash"
        run: |
          set -eu
          git config --global user.email "ci-bot@example.invalid"
          git config --global user.name  "CI Bot"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: "Resolve spec set (common + selected)"
        id: "resolve"
        shell: "bash"
        run: |
          set -euo pipefail
          COMMON_GEN="spec/generation.txt"
          COMMON_TEST="spec/testing.txt"
          ENV_IN="${{ github.event.inputs.env_spec }}"
          FUNC_IN="${{ github.event.inputs.func_spec }}"

          # 必須: generation/testing が無ければ失敗
          for f in "$COMMON_GEN" "$COMMON_TEST"; do
            if [ ! -f "$f" ]; then
              echo "::error::Missing required common spec: $f"
              exit 1
            fi
          done

          # 環境仕様書の選定
          pick_env=""
          if [ -n "$ENV_IN" ] && [ -f "$ENV_IN" ]; then
            pick_env="$ENV_IN"
          elif [ -f spec/environment.txt ]; then
            pick_env="spec/environment.txt"
          else
            env_candidates=$(ls -1 spec/environment*.txt 2>/dev/null || true)
            if [ -n "$env_candidates" ]; then
              pick_env="$(printf '%s\n' $env_candidates | sort | tail -n1)"
            else
              echo "::warning::No environment spec found (optional)"
            fi
          fi

          # 機能仕様書の選定
          pick_func=""
          if [ -n "$FUNC_IN" ] && [ -f "$FUNC_IN" ]; then
            pick_func="$FUNC_IN"
          elif [ -f spec/functional.txt ]; then
            pick_func="spec/functional.txt"
          else
            func_candidates=$(ls -1 spec/functional*.txt 2>/dev/null || true)
            if [ -n "$func_candidates" ]; then
              pick_func="$(printf '%s\n' $func_candidates | sort | tail -n1)"
            else
              echo "::warning::No functional spec found (optional)"
            fi
          fi

          echo "gen=$COMMON_GEN"  >> "$GITHUB_OUTPUT"
          echo "test=$COMMON_TEST" >> "$GITHUB_OUTPUT"
          echo "env=$pick_env"     >> "$GITHUB_OUTPUT"
          echo "func=$pick_func"   >> "$GITHUB_OUTPUT"

          echo "Using specs:"
          echo "  generation: $COMMON_GEN"
          echo "  testing:    $COMMON_TEST"
          echo "  environment: ${pick_env:-'(none)'}"
          echo "  functional:  ${pick_func:-'(none)'}"

      - name: "Build composite prompt (write-back + deliverables)"
        id: "prompt"
        shell: "bash"
        run: |
          set -euo pipefail
          PROMPT_FILE="$RUNNER_TEMP/prompt.md"
          TODAY="$(date -u +%Y-%m-%d)"
          : > "$PROMPT_FILE"

          # 実装方針 + 仕様書“書き戻し”ポリシー + 成果物を明示
          cat >> "$PROMPT_FILE" <<PRELUDE
          # TASK（実装を即実行）
          - Clarification（質問・保留）を行わず、仕様の不足は合理的に補完して実装を完了する。
          - 出力はパッチ（ファイルの追加/更新）のみ。説明文は不要。
          - 生成先: \`src/**\`（アプリ本体）、\`tests/**\`（テスト）。必要に応じて \`app.php\`, \`.htaccess\`,
            \`env-lite.php\`, \`health-lite.php\`, \`tools/\`, \`storage/\`, \`logs/\` も作成可。
          - 1 回の実行でアプリとテスト一式を完成させる。既存は安全に上書き、無ければ新規作成。

          ## DELIVERABLES（必ず生成）
          - app.php
          - src/Kernel.php
          - src/Routing.php
          - src/Controllers/EnvLiteController.php
          - env-lite.php
          - health-lite.php
          - tests/Feature/EnvLiteTest.php   # 期待JSON {"ok":true,"kind":"env-lite"} を検証
          - ai/CHANGELOG_AI.md
          - （必要に応じて）tools/**, storage/**, logs/**

          # SPEC WRITE-BACK POLICY（仕様書に書き戻す）
          - 共通化できるルール／非機能・生成規約・テスト戦略は **spec/generation.txt** と **spec/testing.txt** に書き戻す。
          - 環境ごとの差分は **${{ steps.resolve.outputs.env || '（今回未選定）' }}** に、機能ごとの差分は **${{ steps.resolve.outputs.func || '（今回未選定）' }}** に書き戻す。
          - 追記は各ファイル末尾に見出し「### AI Amendments (${TODAY})」を新設して要点箇条書き、その後、本文へ統合（リライト）しても良い。
          - 書き戻しの結果、重複や矛盾があれば **共通 > 個別** の順で整理し、個別ファイルは共通を上書きする差分のみ残す。
          - 変更履歴は **ai/CHANGELOG_AI.md** に「What changed / Why / Affected files」を追加。

          # POLICY（適用優先度）
          - 常に generation/testing（共通仕様）を適用。
          - environment/functional（可変仕様）は本実行で選定した 1 本を適用。共通と矛盾する場合は **可変仕様を優先**。
          PRELUDE

          # AGENTS.md を先頭に（任意）
          if [ -f "AGENTS.md" ]; then
            printf "\n\n---\n\n# AGENTS.md\n\n" >> "$PROMPT_FILE"
            sed -e 's/\r$//' "AGENTS.md" >> "$PROMPT_FILE"
          fi

          # 結合順：generation → testing → environment? → functional?
          printf "\n\n---\n\n# %s\n\n" "${{ steps.resolve.outputs.gen }}"  >> "$PROMPT_FILE"
          sed -e 's/\r$//' "${{ steps.resolve.outputs.gen }}"               >> "$PROMPT_FILE"

          printf "\n\n---\n\n# %s\n\n" "${{ steps.resolve.outputs.test }}" >> "$PROMPT_FILE"
          sed -e 's/\r$//' "${{ steps.resolve.outputs.test }}"              >> "$PROMPT_FILE"

          if [ -n "${{ steps.resolve.outputs.env }}" ]; then
            printf "\n\n---\n\n# %s\n\n" "${{ steps.resolve.outputs.env }}" >> "$PROMPT_FILE"
            sed -e 's/\r$//' "${{ steps.resolve.outputs.env }}"             >> "$PROMPT_FILE"
          fi

          if [ -n "${{ steps.resolve.outputs.func }}" ]; then
            printf "\n\n---\n\n# %s\n\n" "${{ steps.resolve.outputs.func }}" >> "$PROMPT_FILE"
            sed -e 's/\r$//' "${{ steps.resolve.outputs.func }}"             >> "$PROMPT_FILE"
          fi

          echo "file=$PROMPT_FILE" >> "$GITHUB_OUTPUT"

      - name: "Preflight: check OPENAI_API_KEY"
        env:
          OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
        shell: "bash"
        run: |
          set -eu
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "::error::OPENAI_API_KEY missing"; exit 1
          fi
          echo "OPENAI_API_KEY present"

      # 手動入力で model があればそれを使用
      - name: "Run Codex (with model)"
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.model }}
        id: "codex_with_model"
        uses: "openai/codex-action@main"
        env:
          OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
        with:
          openai-api-key: "${{ secrets.OPENAI_API_KEY }}"
          prompt-file: "${{ steps.prompt.outputs.file }}"
          model: "${{ github.event.inputs.model }}"
          sandbox: "workspace-write"

      # それ以外は既定モデルで実行
      - name: "Run Codex (default model)"
        if: ${{ github.event_name != 'workflow_dispatch' || !github.event.inputs.model }}
        id: "codex_default"
        uses: "openai/codex-action@main"
        env:
          OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
        with:
          openai-api-key: "${{ secrets.OPENAI_API_KEY }}"
          prompt-file: "${{ steps.prompt.outputs.file }}"
          sandbox: "workspace-write"

      - name: "Discard workflow edits (safety)"
        shell: "bash"
        run: |
          set -eu
          if git status --porcelain | grep -E '^[AMDR].*\.github/workflows/'; then
            echo "::warning::Discarding changes under .github/workflows/"
            git checkout -- ".github/workflows" || true
            git restore --staged ".github/workflows" || true
          fi

      - name: "Detect changes"
        id: "diff"
        shell: "bash"
        run: |
          set -eu
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changed files:"
            git diff --name-only || true
          fi

      - name: "Choose token (PAT > GITHUB_TOKEN)"
        id: "tok"
        shell: "bash"
        run: |
          if [ -n "${{ secrets.GH_PAT_WORKFLOWS }}" ]; then
            echo "val=${{ secrets.GH_PAT_WORKFLOWS }}" >> "$GITHUB_OUTPUT"
          else
            echo "val=${{ github.token }}" >> "$GITHUB_OUTPUT"
          fi

      - name: "Create Pull Request (only if changed)"
        if: ${{ steps.diff.outputs.changed == 'true' }}
        uses: "peter-evans/create-pull-request@v7"
        with:
          token: "${{ steps.tok.outputs.val }}"
          title: "AI: code + spec write-back (gen/test common, env/func selected)"
          body: |
            Automated changes by Codex.

            Common specs:
            - ${{ steps.resolve.outputs.gen }}
            - ${{ steps.resolve.outputs.test }}

            Selected specs:
            - env:  ${{ steps.resolve.outputs.env || '(none)' }}
            - func: ${{ steps.resolve.outputs.func || '(none)' }}

            Includes code generation and spec write-back (AI Amendments).
          commit-message: "chore(ai): code + spec write-back (common+selected)"
          branch: "ai/codex/batch-${{ github.run_id }}"
          base: "main"
          delete-branch: true
